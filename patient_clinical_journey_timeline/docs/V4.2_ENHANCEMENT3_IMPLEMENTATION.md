# V4.2 Enhancement #3: Tumor Measurement Extraction

**Status:** âœ… COMPLETE
**Date:** 2025-11-03
**Author:** RADIANT PCA Engineering Team
**Roadmap Reference:** [V4.2_V5.0_UPGRADE_ROADMAP.md](V4.2_V5.0_UPGRADE_ROADMAP.md) (Lines 365-553)

---

## Executive Summary

Successfully implemented **V4.2 Enhancement #3: Tumor Measurement Extraction** using MedGemma LLM to extract structured tumor measurements from radiology reports. Supports bidimensional (RANO standard), volumetric, and qualitative measurements as foundation for V5.0 RANO criteria.

### What Was Accomplished

1. âœ… **Created `TumorMeasurementExtractor` module** ([lib/tumor_measurement_extractor.py](../lib/tumor_measurement_extractor.py))
2. âœ… **Designed comprehensive MedGemma prompt** for measurement extraction
3. âœ… **Integrated into Phase 4** of timeline abstraction pipeline
4. âœ… **Created 16 unit tests** (100% passing)
5. âœ… **Auto-calculation** of cross-sectional area (RANO standard)
6. âœ… **Auto-fix** for common extraction errors (swapped diameters)

---

## Measurement Types Supported

### 1. Bidimensional (RANO Standard)
**Use:** Primary target lesions with measurable enhancement
**Format:** Longest diameter Ã— perpendicular diameter (mm)
**Auto-calculation:** Cross-sectional area = longest Ã— perpendicular

**Example:**
```json
{
  "lesion_id": "target_1",
  "location": "right frontal lobe",
  "measurement_type": "bidimensional",
  "longest_diameter_mm": 31.0,
  "perpendicular_diameter_mm": 24.0,
  "cross_sectional_area_mm2": 744.0
}
```

### 2. Volumetric
**Use:** 3D reconstruction available (advanced imaging)
**Format:** Total volume in mmÂ³

**Example:**
```json
{
  "lesion_id": "target_1",
  "location": "temporal lobe",
  "measurement_type": "volumetric",
  "volume_mm3": 15000.0
}
```

### 3. Qualitative
**Use:** Non-measurable lesions (T2/FLAIR abnormalities, diffuse infiltration)
**Categories:** "stable", "increased", "decreased", "new lesion", "resolved", "present", "absent"

**Example:**
```json
{
  "lesion_id": "non_target_1",
  "location": "corpus callosum",
  "measurement_type": "qualitative",
  "qualitative_assessment": "stable"
}
```

---

## Implementation Details

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 4: Binary Extraction             â”‚
â”‚  (patient_timeline_abstraction_V3.py)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ Imaging report text
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TumorMeasurementExtractor              â”‚
â”‚  (lib/tumor_measurement_extractor.py)   â”‚
â”‚                                         â”‚
â”‚  1. Build MedGemma prompt               â”‚
â”‚  2. Extract measurements via LLM        â”‚
â”‚  3. Parse JSON response                 â”‚
â”‚  4. Create TumorMeasurement objects     â”‚
â”‚  5. Validate measurements               â”‚
â”‚  6. Auto-fix common errors              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ List[TumorMeasurement]
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Store measurements with imaging event  â”‚
â”‚  in timeline_events                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Components

#### 1. TumorMeasurementExtractor Class

**Location:** [lib/tumor_measurement_extractor.py](../lib/tumor_measurement_extractor.py)

**Methods:**
- `extract_measurements()` - Main extraction method
- `_build_extraction_prompt()` - Create MedGemma prompt with RANO rules
- `_parse_llm_response()` - Parse JSON from LLM (handles markdown code blocks)
- `_attempt_fix_measurement()` - Auto-fix validation errors
- `extract_comparison_info()` - Extract prior study comparison (future enhancement)

**Initialization:**
```python
# In patient_timeline_abstraction_V3.py __init__
self.measurement_extractor = TumorMeasurementExtractor(
    medgemma_agent=self.medgemma_agent
)
```

#### 2. MedGemma Prompt Design

**Prompt Structure:**
1. **Measurement Types** - Clear definitions of bidimensional, volumetric, qualitative
2. **Extraction Rules:**
   - Convert all units to millimeters (cm â†’ mm)
   - Extract both diameters for bidimensional
   - Categorize lesions as target vs. non-target
   - Assign sequential IDs ("target_1", "non_target_1", etc.)
   - Extract anatomical location for each lesion
3. **Lesion Categorization:**
   - TARGET: Measurable enhancing tumors
   - NON-TARGET: T2/FLAIR changes, small lesions, post-treatment changes
4. **Output Schema** - JSON structure with example
5. **Critical Instruction** - "Return ONLY valid JSON. No explanatory text."

**Example Prompt Excerpt:**
```
EXTRACTION RULES:
- Extract ALL lesions mentioned (target and non-target)
- Convert all measurements to millimeters (mm)
  * 1 cm = 10 mm
  * Example: "3.1 cm" = 31.0 mm
- If only one diameter given, extract as longest_diameter_mm
- If two diameters given (e.g., "3.1 x 2.4 cm"), extract both
- For qualitative only (no measurements), set measurement_type="qualitative"
- Assign lesion_id sequentially:
  * Use "target_1", "target_2", etc. for measurable enhancing lesions
  * Use "non_target_1", "non_target_2", etc. for non-measurable lesions

OUTPUT SCHEMA (JSON):
{
  "measurements": [
    {
      "lesion_id": "target_1",
      "location": "right frontal lobe",
      "measurement_type": "bidimensional",
      "longest_diameter_mm": 31.0,
      "perpendicular_diameter_mm": 24.0,
      ...
    }
  ],
  "extraction_confidence": "HIGH"
}
```

#### 3. Phase 4 Integration

**Location:** [scripts/patient_timeline_abstraction_V3.py](../scripts/patient_timeline_abstraction_V3.py:2928-2957)

**Integration Point:** Immediately after V4.1 location extraction (Step 5.5)

**Code:**
```python
# V4.2 STEP 5.5: Extract tumor measurements from imaging reports
if self.measurement_extractor and extracted_text and gap['gap_type'] == 'imaging_conclusion':
    try:
        diagnostic_report_id = gap.get('diagnostic_report_id')
        imaging_modality = gap.get('imaging_modality', 'Unknown')

        logger.info(f"ðŸ“ Extracting tumor measurements...")
        measurements = self.measurement_extractor.extract_measurements(
            report_text=extracted_text,
            source_id=diagnostic_report_id,
            imaging_modality=imaging_modality
        )

        if measurements:
            logger.info(f"ðŸ“ Extracted {len(measurements)} tumor measurements")
            measurements_dicts = [m.to_dict() for m in measurements]

            # Store measurements with imaging event
            for img in self.timeline_events:
                if img.get('event_type') == 'imaging' and
                   img.get('diagnostic_report_id') == diagnostic_report_id:
                    img['tumor_measurements'] = measurements_dicts
                    break
```

---

## Validation & Auto-Fix

### Built-in Validation

The `TumorMeasurement.validate()` method checks:
1. **Measurement type** must be "bidimensional", "volumetric", or "qualitative"
2. **Bidimensional:** Both diameters required, longest â‰¥ perpendicular
3. **Volumetric:** `volume_mm3` required
4. **Qualitative:** `qualitative_assessment` required

### Auto-Fix Features

#### 1. Swapped Diameters
**Problem:** LLM sometimes extracts perpendicular > longest
**Fix:** Automatically swap diameters

```python
if "Longest diameter must be >=" in str(errors):
    # Swap them
    measurement.longest_diameter_mm, measurement.perpendicular_diameter_mm =
        measurement.perpendicular_diameter_mm, measurement.longest_diameter_mm
```

#### 2. Incomplete Bidimensional
**Problem:** Only one diameter extracted
**Fix:** Convert to qualitative with assessment="measurable"

```python
if "require both diameters" in str(errors):
    measurement.measurement_type = "qualitative"
    measurement.qualitative_assessment = "measurable"
```

---

## Testing

### Test Suite: [tests/test_tumor_measurement_extractor.py](../tests/test_tumor_measurement_extractor.py)

**Statistics:**
- **Total Tests:** 16
- **Pass Rate:** 100% (16/16)
- **Execution Time:** <0.01s

**Test Coverage:**

#### Core Functionality (4 tests)
- âœ… Initialize extractor with/without agent
- âœ… Extract single bidimensional measurement
- âœ… Extract multiple measurements (target + non-target)
- âœ… Extract volumetric measurement

#### Edge Cases (5 tests)
- âœ… No agent returns empty list
- âœ… Empty report returns empty list
- âœ… Short report (<50 chars) returns empty list
- âœ… Invalid JSON returns None
- âœ… Long report (>8000 chars) truncation

#### Parsing (2 tests)
- âœ… Parse markdown JSON response (```json ... ```)
- âœ… Parse plain JSON response

#### Validation & Auto-Fix (2 tests)
- âœ… Auto-fix swapped diameters
- âœ… Auto-calculate cross-sectional area

#### Integration (3 tests)
- âœ… Build extraction prompt
- âœ… Measurement serialization to JSON
- âœ… End-to-end extraction workflow

---

## Example Usage

### Extracting from MRI Report

**Input Report:**
```
MRI BRAIN WITH AND WITHOUT CONTRAST

COMPARISON: Prior MRI 6 months ago

FINDINGS:
1. Residual enhancing lesion in the right frontal lobe measures 2.8 x 2.1 cm,
   slightly decreased from prior (3.1 x 2.4 cm).

2. Stable T2/FLAIR signal abnormality in the corpus callosum, unchanged.

3. No new enhancing lesions identified.

IMPRESSION:
Slight interval decrease in size of right frontal lobe tumor. Otherwise stable.
```

**Extracted Measurements:**
```json
[
  {
    "lesion_id": "target_1",
    "location": "right frontal lobe",
    "measurement_type": "bidimensional",
    "longest_diameter_mm": 28.0,
    "perpendicular_diameter_mm": 21.0,
    "cross_sectional_area_mm2": 588.0,
    "extracted_from_text": "residual enhancing lesion 2.8 x 2.1 cm",
    "confidence": "HIGH",
    "extraction_method": "llm_extraction",
    "source_id": "DiagnosticReport/abc123",
    "extracted_at": "2025-11-03T14:32:45.123456"
  },
  {
    "lesion_id": "non_target_1",
    "location": "corpus callosum",
    "measurement_type": "qualitative",
    "qualitative_assessment": "stable",
    "extracted_from_text": "stable T2/FLAIR abnormality",
    "confidence": "HIGH",
    "extraction_method": "llm_extraction",
    "source_id": "DiagnosticReport/abc123",
    "extracted_at": "2025-11-03T14:32:45.123456"
  }
]
```

### Storage in Timeline Event

```json
{
  "event_type": "imaging",
  "event_date": "2024-06-15",
  "stage": 5,
  "source": "v_imaging",
  "imaging_modality": "MRI Brain",
  "diagnostic_report_id": "DiagnosticReport/abc123",
  "tumor_measurements": [
    {
      "lesion_id": "target_1",
      "location": "right frontal lobe",
      "measurement_type": "bidimensional",
      "longest_diameter_mm": 28.0,
      "perpendicular_diameter_mm": 21.0,
      "cross_sectional_area_mm2": 588.0,
      ...
    },
    {
      "lesion_id": "non_target_1",
      "location": "corpus callosum",
      "measurement_type": "qualitative",
      "qualitative_assessment": "stable",
      ...
    }
  ]
}
```

---

## Benefits Achieved

### 1. Foundation for V5.0 RANO Criteria
- Structured bidimensional measurements enable sum-of-products calculation
- Target vs. non-target lesion classification
- Cross-sectional area auto-calculated for RANO analysis

### 2. Improved Data Quality
- Standardized measurement format across all imaging events
- Units consistently in millimeters (no cm/mm confusion)
- Validation ensures measurement consistency

### 3. Temporal Tracking
- `extracted_at` timestamp enables tracking when measurements were obtained
- `source_id` links measurements to specific imaging studies
- Enables longitudinal tumor growth/response analysis

### 4. LLM Robustness
- Handles markdown code blocks in LLM responses
- Auto-fixes common extraction errors (swapped diameters)
- Graceful degradation (qualitative fallback)

### 5. Provenance Tracking
- `extracted_from_text` preserves source context
- `confidence` level (HIGH/MEDIUM/LOW) tracks extraction quality
- `extraction_method` documents how measurement was obtained

---

## Performance Characteristics

| Metric | Value |
|--------|-------|
| Report text limit | 8000 chars (auto-truncated) |
| Minimum report length | 50 chars (short reports skipped) |
| LLM calls per imaging report | 1 |
| Validation errors auto-fixed | 2 types (swapped diameters, incomplete bidimensional) |
| JSON parsing robustness | Handles markdown code blocks |
| Cross-sectional area calculation | Automatic in to_dict() |

---

## Future Enhancements (V5.0)

### Planned for V5.0
1. **Full RANO Criteria Implementation:**
   - Automatic sum-of-products calculation
   - Percent change from baseline/nadir
   - New lesion detection across studies
   - CR/PR/SD/PD classification

2. **Enhanced Comparison Analysis:**
   - `extract_comparison_info()` method (already stubbed)
   - Link measurements to prior studies
   - Calculate interval change automatically

3. **3D Volumetric Analysis:**
   - Enhanced support for volumetric measurements
   - Integration with 3D reconstruction data

4. **Measurement Validation:**
   - Compare LLM extractions to structured FHIR observations
   - Flag discrepancies for manual review

---

## Files Created/Modified

| File | Status | Lines | Description |
|------|--------|-------|-------------|
| [lib/tumor_measurement_extractor.py](../lib/tumor_measurement_extractor.py) | âœ… Created | 350 | Core extraction module |
| [tests/test_tumor_measurement_extractor.py](../tests/test_tumor_measurement_extractor.py) | âœ… Created | 366 | Unit test suite |
| [scripts/patient_timeline_abstraction_V3.py](../scripts/patient_timeline_abstraction_V3.py) | âœ… Modified | +47 | Integration into Phase 4 |

**Total Lines Added:** 763

---

## References

1. **V4.2 Roadmap:** [V4.2_V5.0_UPGRADE_ROADMAP.md](V4.2_V5.0_UPGRADE_ROADMAP.md) (Lines 365-553)
2. **RANO Criteria:** Response Assessment in Neuro-Oncology (bidimensional standard)
3. **TumorMeasurement Dataclass:** [lib/clinical_event.py](../lib/clinical_event.py)
4. **V4.2 Phase 1 Dataclass Implementation:** [V4.2_PHASE1_IMPLEMENTATION.md](V4.2_PHASE1_IMPLEMENTATION.md)

---

**Status:** âœ… V4.2 Enhancement #3 COMPLETE
**Next:** V4.2 Enhancement #4 (Qualitative Treatment Response)
**Tests:** 16/16 passing (100%)
**Approved:** Pending review
