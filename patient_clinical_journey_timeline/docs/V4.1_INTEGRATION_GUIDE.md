# V4.1 Integration Guide - Minimal Integration Approach

**Status**: Integration instructions for adding V4.1 features to main script
**Target**: `scripts/patient_timeline_abstraction_V3.py` (3,903 lines)
**Estimated Time**: 4-6 hours
**Date**: 2025-11-03

---

## Overview

This guide provides **exact code locations** and **minimal code additions** needed to integrate V4.1 tumor location and institution tracking into the existing V4 pipeline.

**Design Principle**: Add V4.1 features with MINIMAL disruption to existing V4 code

---

## Integration Points Summary

| Integration Point | Line Number | Description | Estimated LOC |
|-------------------|-------------|-------------|---------------|
| 1. Import V4.1 modules | ~100 | Add import statements | 3 lines |
| 2. Initialize extractors | ~1100 | Create extractor instances | 5 lines |
| 3. Extract institution from procedures | ~1200 | Add to procedure loading | 10 lines |
| 4. Extract institution from imaging | ~1400 | Add to imaging loading | 10 lines |
| 5. Extract location from imaging reports | ~2800 | Add to imaging binary processing | 15 lines |
| 6. Extract location from operative notes | ~3100 | Add to operative note processing | 15 lines |
| 7. Add clinical_features to timeline events | ~1600 | Extend event dict | 10 lines |
| 8. Update JSON serialization | ~3700 | Add V4.1 fields to output | 10 lines |

**Total New Code**: ~78 lines

---

## Step 1: Add V4.1 Imports (Line ~100)

**Location**: After existing `lib` imports (around line 100)

**Current code** (lines 60-66):
```python
# Import agents for Phase 4
try:
    from agents import MedGemmaAgent, BinaryFileAgent, ExtractionResult
    AGENTS_AVAILABLE = True
except ImportError as e:
    logger.warning(f"Could not import agents: {e}")
    AGENTS_AVAILABLE = False
```

**ADD AFTER** line 66:
```python
# V4.1: Import tumor location and institution tracking
try:
    from lib.tumor_location_extractor import TumorLocationExtractor
    from lib.institution_tracker import InstitutionTracker
    V41_FEATURES_AVAILABLE = True
except ImportError as e:
    logger.warning(f"Could not import V4.1 features: {e}")
    V41_FEATURES_AVAILABLE = False
```

---

## Step 2: Initialize V4.1 Extractors (Line ~1100)

**Location**: In `PatientTimelineAbstractor.__init__()` method after agent initialization

**Find this code** (around line 1100):
```python
        # Initialize agents for binary extraction
        if AGENTS_AVAILABLE:
            self.medgemma_agent = MedGemmaAgent(model_name="gemma2:27b")
            self.binary_agent = BinaryFileAgent(s3_prefix="s3://radiant-prd-...")
        else:
            self.medgemma_agent = None
            self.binary_agent = None
```

**ADD AFTER**:
```python
        # V4.1: Initialize location and institution extractors
        if V41_FEATURES_AVAILABLE:
            self.location_extractor = TumorLocationExtractor()
            self.institution_tracker = InstitutionTracker(primary_institution="Children's Hospital of Philadelphia")
            logger.info("‚úÖ V4.1 features initialized (location + institution tracking)")
        else:
            self.location_extractor = None
            self.institution_tracker = None
```

---

## Step 3: Extract Institution from Procedures (Line ~1200)

**Location**: In `_load_procedures()` method after procedures are loaded

**Find this code** (around line 1200):
```python
        for row in cursor.fetchall():
            proc_dict = dict(zip([desc[0] for desc in cursor.description], row))
            procedures.append(proc_dict)

        logger.info(f"‚úÖ {len(procedures)} records")
        return procedures
```

**MODIFY to**:
```python
        for row in cursor.fetchall():
            proc_dict = dict(zip([desc[0] for desc in cursor.description], row))

            # V4.1: Extract institution from procedure
            if self.institution_tracker:
                institution_feature = self.institution_tracker.extract_from_procedure(proc_dict)
                if institution_feature:
                    proc_dict['v41_institution'] = institution_feature.to_dict()

            procedures.append(proc_dict)

        logger.info(f"‚úÖ {len(procedures)} records")
        return procedures
```

---

## Step 4: Extract Institution from Imaging (Line ~1400)

**Location**: In `_load_imaging()` method after imaging records are loaded

**Find this code** (around line 1400):
```python
        for row in cursor.fetchall():
            img_dict = dict(zip([desc[0] for desc in cursor.description], row))
            imaging.append(img_dict)

        logger.info(f"‚úÖ {len(imaging)} records")
        return imaging
```

**MODIFY to**:
```python
        for row in cursor.fetchall():
            img_dict = dict(zip([desc[0] for desc in cursor.description], row))

            # V4.1: Extract institution from imaging
            if self.institution_tracker:
                institution_feature = self.institution_tracker.extract_from_imaging(img_dict)
                if institution_feature:
                    img_dict['v41_institution'] = institution_feature.to_dict()

            imaging.append(img_dict)

        logger.info(f"‚úÖ {len(imaging)} records")
        return imaging
```

---

## Step 5: Extract Location from Imaging Reports (Line ~2800)

**Location**: In Phase 4 binary extraction loop for imaging reports

**Find this code** (around line 2800, in the imaging_reports section):
```python
                # Extract imaging report text
                extracted_text = self.binary_agent.extract_content(binary_id)

                # Store for later use
                imaging_report_texts[diagnostic_report_id] = extracted_text
```

**ADD AFTER**:
```python
                # V4.1: Extract tumor location from imaging report
                if self.location_extractor and extracted_text:
                    location_feature = self.location_extractor.extract_location_from_text(
                        text=extracted_text,
                        source_type="preop_imaging" if "preop" in dr_type.lower() else "imaging",
                        source_id=diagnostic_report_id,
                        progression_status="initial"  # Could be enhanced with temporal logic
                    )
                    if location_feature:
                        # Store location with imaging record
                        for img in self.imaging:
                            if img.get('diagnostic_report_id') == diagnostic_report_id:
                                img['v41_tumor_location'] = location_feature.to_dict()
                                logger.info(f"üìç Extracted location from imaging: {location_feature.locations}")
                                break
```

---

## Step 6: Extract Location from Operative Notes (Line ~3100)

**Location**: In Phase 4 binary extraction loop for operative records

**Find this code** (around line 3100, in the operative_records section):
```python
                # Extract operative note text
                extracted_text = self.binary_agent.extract_content(binary_id)

                # Extract EOR
                eor_result = self.medgemma_agent.extract(extracted_text, ...)
```

**ADD AFTER EOR extraction**:
```python
                # V4.1: Extract tumor location from operative note
                if self.location_extractor and extracted_text:
                    location_feature = self.location_extractor.extract_location_from_text(
                        text=extracted_text,
                        source_type="operative_note",
                        source_id=binary_id,
                        progression_status=None  # Could be enhanced with temporal logic
                    )
                    if location_feature:
                        # Store location with procedure record
                        for proc in self.procedures:
                            if proc.get('proc_id') == procedure_id:
                                proc['v41_tumor_location'] = location_feature.to_dict()
                                logger.info(f"üìç Extracted location from operative note: {location_feature.locations}")
                                break
```

---

## Step 7: Add clinical_features to Timeline Events (Line ~1600)

**Location**: In methods that create timeline events (surgery, imaging, etc.)

**Find surgery event creation** (around line 1600):
```python
        surgery_event = {
            "event_type": "surgery",
            "date": proc_performed_date_time,
            "procedure_id": proc_id,
            "procedure_display": proc_display,
            "surgery_number": surgery_number,  # V4 feature
            "timing_context": timing_context,  # V4 feature
            # ... other fields
        }
```

**MODIFY to include clinical_features**:
```python
        surgery_event = {
            "event_type": "surgery",
            "date": proc_performed_date_time,
            "procedure_id": proc_id,
            "procedure_display": proc_display,
            "surgery_number": surgery_number,  # V4 feature
            "timing_context": timing_context,  # V4 feature
            # ... other fields

            # V4.1: Add clinical features
            "clinical_features": {}
        }

        # V4.1: Add institution if available
        if proc_dict.get('v41_institution'):
            surgery_event['clinical_features']['institution'] = proc_dict['v41_institution']

        # V4.1: Add tumor location if available
        if proc_dict.get('v41_tumor_location'):
            surgery_event['clinical_features']['tumor_location'] = proc_dict['v41_tumor_location']
```

**Apply same pattern to**:
- Imaging events (add institution + location)
- Chemotherapy events (add institution if needed)
- Radiation events (add institution if needed)

---

## Step 8: Update JSON Output Serialization (Line ~3700)

**Location**: In `_generate_artifacts()` method where JSON is written

**Find this code** (around line 3700):
```python
        # Write JSON artifact
        with open(json_output_path, 'w') as f:
            json.dump(timeline_data, f, indent=2, default=str)
```

**NO CHANGES NEEDED** - Our V4.1 features use `.to_dict()` which returns JSON-serializable dicts!

---

## Testing Strategy

### Minimal Integration Test

**Before full integration**, test V4.1 modules standalone:

```bash
cd /Users/resnick/Documents/GitHub/RADIANT_PCA/BRIM_Analytics/patient_clinical_journey_timeline

# Test location extractor
python3 lib/tumor_location_extractor.py

# Test institution tracker
python3 lib/institution_tracker.py
```

### Integration Test with Limited Extraction

After integration, run with `--max-extractions 5`:

```bash
export AWS_PROFILE=radiant-prod
python3 scripts/patient_timeline_abstraction_V3.py \
  --patient-id eQSB0y3q.OmvN40Yhg9.eCBk5-9c-Qp-FT3pBWoSGuL83 \
  --output-dir output/v41_integration_test \
  --force-reclassify \
  --max-extractions 5
```

**Expected output**:
- V4.1 features initialized log message
- "üìç Extracted location" log messages
- `clinical_features` in JSON output with `institution` and `tumor_location` fields

### Full End-to-End Test

After successful limited test:

```bash
python3 scripts/patient_timeline_abstraction_V3.py \
  --patient-id eQSB0y3q.OmvN40Yhg9.eCBk5-9c-Qp-FT3pBWoSGuL83 \
  --output-dir output/v41_full_test \
  --force-reclassify
```

---

## Validation Checklist

After integration, verify:

- [ ] No errors on script startup
- [ ] "‚úÖ V4.1 features initialized" appears in logs
- [ ] Institution extracted from at least 1 procedure
- [ ] Institution extracted from at least 1 imaging study
- [ ] Location extracted from at least 1 imaging report
- [ ] Location extracted from at least 1 operative note
- [ ] `clinical_features` dict present in timeline events
- [ ] JSON serialization completes successfully
- [ ] All V4 features still functional (WHO triage, treatment ordinality, EOR, FeatureObject)

---

## Rollback Plan

If integration causes issues:

```bash
# Revert to V4 without V4.1
git checkout feature/multi-agent-framework  # V4 stable branch
git reset --hard origin/feature/multi-agent-framework
```

---

## Expected Performance Impact

Based on V4.1 module design:

- **Phase 1 (Institution extraction from procedures/imaging)**: +30-60 seconds
  - Simple dict lookups, no LLM calls
- **Phase 4 (Location extraction from binaries)**: +15-30 minutes for 1,500 documents
  - Brain location normalizer: ~100-200ms per document
  - Laterality regex: ~10-20ms per document

**Total runtime increase**: ~15-35 minutes (acceptable for 6-8 hour total runtime)

---

## Next Steps After Integration

1. Run integration test with `--max-extractions 5`
2. Verify V4.1 features in JSON output
3. Run full end-to-end test
4. Analyze V4.1 extraction quality:
   - Location accuracy (compare to radiology reports)
   - Institution detection rate (expect 85%+ from structured fields)
   - Laterality detection accuracy
5. Create integration PR and merge to main branch
6. Update V4.1 documentation with actual test results

---

## Known Limitations

1. **Location temporal tracking**: Initial implementation uses simple "initial" status
   - Enhancement: Add progression detection logic based on event dates
2. **Institution-aware EOR**: Not yet implemented
   - Enhancement: Modify EOR orchestrator to consider institution (external surgery detection)
3. **Location from pathology reports**: Not yet integrated
   - Enhancement: Add location extraction to pathology binary processing

These can be addressed in V4.2 after validating core V4.1 functionality.

---

## Summary

V4.1 integration requires **~78 lines of code** across **8 integration points** in the 3,903-line main script. The integration is designed to be **minimal, non-disruptive, and fully backward compatible** with V4.

**Key files modified**:
- `scripts/patient_timeline_abstraction_V3.py` (+78 lines)

**Key files unchanged**:
- All V4 lib modules (no modifications needed)
- All data loading queries (no schema changes)
- Output artifact structure (extended, not modified)
