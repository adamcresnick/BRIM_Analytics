# CBTN REDCap Integration Strategy

## 1. Executive Summary

The goal of this initiative is to automate the population of the CBTN (PID: 54294) REDCap project using data extracted directly from the EHR via the `patient_timeline_abstraction_V3.py` pipeline. This will reduce manual data entry, improve data timeliness, and enhance data quality.

This document outlines a phased testing and implementation strategy. The core of the technical solution is a new script, `map_to_redcap.py`, which will transform the JSON artifact from the existing pipeline and use the REDCap API to populate the appropriate CRF.

The mapping logic is detailed in the accompanying CSV files in this directory, broken down by REDCap form.

## 2. Pre-Implementation Testing Strategy

Before any data is written to the live REDCap project, a rigorous, phased testing approach is critical to ensure accuracy and prevent data corruption.

### Phase 1: Data Source Validation (Athena Queries)

**Goal:** Verify that all proposed `Direct Athena Query` mappings are valid and return the expected data.

**Process:**
1.  For a cohort of 5-10 test patients, execute the simple SQL queries proposed in the mapping CSVs against the `fhir_prd_db` Athena database.
2.  Manually review the results against the source data in the EHR (if possible) or against logical expectations.
3.  **Success Criteria:** All queries run successfully and return data in the expected format for >95% of the test cohort where data is expected to exist.

### Phase 2: Pipeline Artifact Validation

**Goal:** Confirm the accuracy of the complex data points generated by the full `patient_timeline_abstraction_V3.py` pipeline.

**Process:**
1.  Using the same test cohort, run the full abstraction pipeline to generate the `timeline.json` artifacts.
2.  Manually inspect the contents of each JSON file, paying close attention to the complex, LLM-generated fields:
    *   `who_2021_classification`: Is the diagnosis and grade correct?
    *   `extent_of_resection_v4`: Does the extracted EOR match the surgical report?
    *   `TreatmentResponseExtractor` output: Does the assessment of "stable", "improved", or "worse" match the imaging report's conclusion?
    *   `TumorMeasurementExtractor` output: Are the extracted measurements accurate?
3.  **Success Criteria:** The extracted data in the JSON artifact has a >95% accuracy rate when compared to manual review of the source documents for the test cohort.

### Phase 3: Simulated REDCap Payload Generation (Dry Run)

**Goal:** Validate the entire mapping logic and the structure of the data payload before interacting with the REDCap API.

**Process:**
1.  Develop the `map_to_redcap.py` script with a **"dry run"** mode.
2.  In this mode, the script will perform all data retrieval (from JSON/Athena) and all data transformations.
3.  Instead of making an API call to REDCap, it will generate a local JSON file representing the exact payload it *would have sent*.
4.  Manually review this payload file. Check for:
    *   Correct REDCap variable names.
    *   Correct data formatting (e.g., dates in `YYYY-MM-DD`, categorical values as '0', '1', etc.).
    *   Correct use of REDCap event names (e.g., `diagnoses_arm_1`).
    *   Correct instantiation for repeating instruments (e.g., creating instance #2 of the "Treatment" form for a second surgery).
5.  **Success Criteria:** The generated payloads are 100% compliant with the REDCap data dictionary and project structure.

Only after these three phases are successfully completed should the `map_to_redcap.py` script be run in "live" mode against a development/staging REDCap project, followed by a final validation before moving to production.

## 3. Proposed Technical Architecture

-   **New Script:** `map_to_redcap.py`
-   **Language:** Python
-   **Core Library:** `PyCap` (or similar REDCap API wrapper).
-   **Inputs:** `patient_id`, path to the corresponding `timeline.json` artifact.
-   **Function:**
    1.  Initialize REDCap API connection.
    2.  Fetch existing record data for the patient to prevent duplication.
    3.  Load and parse the `timeline.json` artifact.
    4.  Execute mapping logic as defined in the strategy CSVs.
    5.  For event-driven forms (Diagnosis, Treatment, etc.), create new instances as needed.
    6.  Construct the data payload.
    7.  Import the data into the REDCap project via the API.

## 4. Core Mapping Principles

-   **Event-Driven:** The timeline is the source of truth. New events in the timeline (a surgery, a new imaging study) trigger the creation of new, timestamped data entries in REDCap. This is more accurate than fixed-interval follow-ups.
-   **Provenance is Key:** Every automatically populated field should be auditable. We will use a dedicated notes field or a parallel field (e.g., `[field_name]_source`) to tag data with `'EHR_PIPELINE_V3'`.
-   **Start with High-Confidence Data:** The initial implementation should focus on fields with "High" feasibility. "Medium" feasibility fields can be added in a second pass. "Low" feasibility fields (e.g., Family History) should be considered for future pipeline enhancements.

## 5. Detailed Mapping Files

The specific, field-level mapping strategy is detailed in the following CSV files within this directory, with each file corresponding to one or more REDCap forms:

- `enrollment_demographics_mapping.csv`
- `medical_history_mapping.csv`
- `diagnosis_mapping.csv`
- `treatment_mapping.csv`
- `updates_and_imaging_mapping.csv`
- `braf_alteration_details_mapping.csv`
- `hydrocephalus_details_mapping.csv`
- `concomitant_medications_mapping.csv`
- `measurements_mapping.csv`
- `specimen_mapping.csv`

## 6. Identified Gaps & Future Work

-   **Family History:** The `Medical History` form contains detailed questions about cancer history in relatives. This data is typically found in unstructured social history notes and is not part of the current pipeline. A future enhancement could be a `FamilyHistoryExtractor` agent.
-   **Subjective/Patient-Reported Data:** Any fields requiring direct patient input or subjective assessment of symptoms (e.g., quality of life scores) are out of scope for this automated process.
-   **Protocol Mapping:** Mapping chemotherapy drug combinations to specific clinical trial `protocol_name` options may require creating and maintaining a separate mapping dictionary, as the raw drug names may not always have a 1:1 correspondence with a protocol name.
