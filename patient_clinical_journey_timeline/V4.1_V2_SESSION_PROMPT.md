# New Session Prompt: Patient Timeline Abstraction V4.1+V2 Production & V4.2/V5.0 Development

**Use this prompt to continue work on the Patient Clinical Journey Timeline system at the V4.1+V2 production validation stage and prepare for V4.2/V5.0 enhancements**

---

## Executive Summary: Where We Are (2025-11-03)

**Current Version**: V4.1+V2 (Integrated)
**Status**: üîÑ **PRODUCTION VALIDATION IN PROGRESS** (Shell 0b7fb6)
**Next Steps**: Test completion ‚Üí V4.2/V5.0 implementation planning

### Major Milestone Achieved Today (2025-11-03)

We successfully integrated **V4.1 features** (tumor location + institution tracking) with **V2 schema enhancements** (optimized Athena views) and **fixed critical bugs** blocking production deployment. A full production test is currently running to validate the complete integration.

---

## Table of Contents

1. [Current Status: V4.1+V2](#current-status-v41v2)
2. [Session 2025-11-03 Summary](#session-2025-11-03-summary)
3. [V4.2/V5.0 Upgrade Roadmap](#v42v50-upgrade-roadmap)
4. [Running Production Test](#running-production-test)
5. [Key File Locations](#key-file-locations)
6. [Critical Fixes Applied Today](#critical-fixes-applied-today)
7. [Environment & Configuration](#environment--configuration)
8. [Test Patient Details](#test-patient-details)
9. [Quick Start Commands](#quick-start-commands)
10. [Next Session Tasks](#next-session-tasks)

---

## Current Status: V4.1+V2

### Feature Integration Matrix

| Feature Set | Components | Status | Implementation |
|-------------|------------|--------|----------------|
| **V4 Base (5 features)** | WHO Triage, Treatment Ordinality, TIFF Date Mismatch, EOR Orchestrator, FeatureObject | ‚úÖ PRODUCTION | Commit 66af898 |
| **V4.1 Core (2 features)** | Tumor Location Extraction, Institution Tracking | ‚úÖ INTEGRATED | Lines 1574-1850 |
| **V2 Schema (Steps 1,2,5)** | V2 Athena fields, Tier 1 optimization, v2_annotation | ‚úÖ INTEGRATED | Lines 1492-1850 |
| **V2 Athena Views** | v2_procedures_tumor, v2_imaging, v2_procedure_specimen_link | ‚úÖ FIXED & DEPLOYED | 2025-11-03 |
| **V2 Steps 3-4** | Encounter-based document discovery | üìã PLANNED FOR V4.2 | See roadmap |
| **V4.2 Enhancements** | Event dataclass, tumor measurements, treatment response | üìã PLANNED | 8-10 weeks |
| **V5.0 Advanced** | Full RANO criteria, longitudinal tracking | üìã PLANNED | 12-16 weeks |

### Version Compatibility

```
V3 (Baseline) ‚Üí V4 (5 features) ‚Üí V4.1+V2 (Current) ‚Üí V4.2 (Planned) ‚Üí V5.0 (Future)
     ‚Üì               ‚Üì                    ‚Üì                  ‚Üì               ‚Üì
 7-stage       WHO Triage         Location +        Dataclass +      Full RANO +
 timeline      EOR Orchestrator   Institution       Measurements     Longitudinal
 100%          100% compat        85% Tier 1        Structured       Progression
 compatible                       coverage          events           tracking
```

---

## Session 2025-11-03 Summary

### Session Goals Achieved

1. ‚úÖ **Completed V4.1+V2 integration** (location, institution, V2 schema)
2. ‚úÖ **Fixed V2 Athena view date casting bugs** (v2_procedures_tumor, v2_procedure_specimen_link)
3. ‚úÖ **Fixed V4.1 location extractor initialization bug** (json_path ‚Üí mapping_path)
4. ‚úÖ **Created comprehensive V4.2/V5.0 upgrade roadmap** (2,000+ lines)
5. ‚úÖ **Started production validation run** (Shell 0b7fb6)

### Timeline of Work

**Morning (09:00-12:00)**: V4.1+V2 Integration
- Reviewed V2 schema documentation
- Created [`V4.1_V2_SCHEMA_INTEGRATION_PLAN.md`](docs/V4.1_V2_SCHEMA_INTEGRATION_PLAN.md) (comprehensive integration plan)
- Implemented V2 Steps 1, 2, 5
- Integrated V4.1 location + institution tracking
- Discovered Athena view date casting bugs

**Afternoon (13:00-16:00)**: Bug Fixes & External Review
- Fixed v2_procedures_tumor date casting (lines 424-429)
- Fixed v2_procedure_specimen_link date casting (line 15)
- Fixed V4.1 location extractor initialization
- Deployed fixed views to Athena (SUCCEEDED)
- Received external expert review of V4.1+V2 code
- Assessed review recommendations

**Evening (17:00-20:30)**: Roadmap & Production Testing
- Created [`V4.2_V5.0_UPGRADE_ROADMAP.md`](docs/V4.2_V5.0_UPGRADE_ROADMAP.md)
- Killed all old zombie test processes
- Started fresh V4.1+V2 production run (Shell 0b7fb6)
- All features initialized successfully ‚úÖ

---

## V4.2/V5.0 Upgrade Roadmap

### Document Location

**File**: [`docs/V4.2_V5.0_UPGRADE_ROADMAP.md`](docs/V4.2_V5.0_UPGRADE_ROADMAP.md)
**Size**: 2,000+ lines
**Created**: 2025-11-03

### Key Enhancements Planned

#### V4.2 (Q1 2026 - 8-10 weeks)

1. **Centralized Event Model** (‚≠ê‚≠ê‚≠ê CRITICAL)
   - Replace dictionary-based events with `ClinicalEvent` dataclass
   - `TumorMeasurement` and `TreatmentResponse` dataclasses
   - Built-in validation, type safety, consistent serialization
   - **Priority**: HIGH - Foundation for all future work

2. **V2 Document Discovery** (Steps 3-4)
   - Encounter-based lookup using `v2_document_reference_enriched`
   - Eliminates temporal matching fragility
   - Expected: 95%+ success rate (vs. 70% current)
   - **Priority**: HIGH - Already planned, just deferred

3. **Tumor Measurement Extraction** (Phase 4.5)
   - LLM-based extraction from imaging reports
   - Bidimensional (RANO standard) + volumetric + qualitative
   - Foundation for V5.0 RANO criteria
   - **Priority**: MEDIUM-HIGH

4. **Basic Treatment Response** (Qualitative)
   - "improved", "stable", "worse" categories
   - Links imaging to prior treatments
   - Prepares for full RANO in V5.0
   - **Priority**: MEDIUM

#### V5.0 (Q2-Q3 2026 - 12-16 weeks)

1. **Full RANO Criteria Engine**
   - Complete Response (CR), Partial Response (PR), Stable Disease (SD), Progressive Disease (PD)
   - Sum of products calculation
   - Longitudinal tracking across ‚â•2 timepoints
   - New lesion detection
   - Clinical validation: >90% agreement with oncologist

2. **Pseudoprogression Detection** (Exploratory)
   - Research-grade feature
   - Differentiate treatment effects from true progression

### External Review Recommendations

| Recommendation | Decision | Priority | Implementation |
|---|---|---|---|
| #1: Externalize SQL | **DEFER to V6.0+** | Low | View-based architecture sufficient |
| #2: Event Dataclass | **ACCEPT** | ‚≠ê‚≠ê‚≠ê HIGH | V4.2 - Weeks 1-4 |
| #3: RANO Response | **ACCEPT (Phased)** | ‚≠ê‚≠ê MEDIUM | V4.2 qualitative ‚Üí V5.0 full RANO |
| #4: V2 Document Discovery | **ACCEPT** | ‚≠ê‚≠ê‚≠ê HIGH | V4.2 - Week 5 |

---

## Running Production Test

### Current Test Details

**Shell ID**: `0b7fb6`
**Command**:
```bash
cd /Users/resnick/Documents/GitHub/RADIANT_PCA/BRIM_Analytics/patient_clinical_journey_timeline
export AWS_PROFILE=radiant-prod
python3 scripts/patient_timeline_abstraction_V3.py \
  --patient-id eQSB0y3q.OmvN40Yhg9.eCBk5-9c-Qp-FT3pBWoSGuL83 \
  --output-dir output/v4.1_v2_final_production \
  --force-reclassify
```

**Status**: üîÑ RUNNING (Started 20:28:16)
**Output**: `output/v4.1_v2_final_production/`
**Log**: `output/v4.1_v2_final_production.log`

### Test Configuration

- **Patient**: eQSB0y3q.OmvN40Yhg9.eCBk5-9c-Qp-FT3pBWoSGuL83 (Astrocytoma, IDH-mutant, Grade 3)
- **Settings**: Full production (no document limits, no --max-extractions)
- **Features Enabled**:
  - ‚úÖ V4 Base (5 features)
  - ‚úÖ V4.1 Location Tracking (32 CBTN codes)
  - ‚úÖ V4.1 Institution Tracking (3-tier strategy)
  - ‚úÖ V2 Schema Integration (Steps 1, 2, 5)
  - ‚úÖ Fixed V2 Athena Views

### Initialization Success (20:28:16)

```
‚úÖ MedGemma (gemma2:27b) is available via Ollama
‚úÖ AWS Textract enabled for TIFF/image extraction
‚úÖ MedGemma and BinaryFile agents initialized
‚úÖ Initialized TumorLocationExtractor with 32 CBTN codes
‚úÖ Initialized InstitutionTracker (primary: Children's Hospital of Philadelphia)
‚úÖ V4.1 features initialized (location + institution tracking)
```

### Phase Progress (As of 20:41:17)

**Phase 0: WHO 2021 Classification** ‚úÖ COMPLETE
- Found 7 molecular test records
- Found 50 pathology diagnostic records
- Extracted 8 molecular markers (IDH1, MSH6, ATRX, DNMT3A, NF1, PIK3CA, TP53, MET)
- WHO Triage: Adult-type diffuse gliomas (86.8% context savings)
- **Result**: Astrocytoma, IDH-mutant, CNS WHO grade 3
- **Confidence**: HIGH

**Phase 1: Load Structured Data** üîÑ IN PROGRESS (as of 20:41:20)
- Demographics: ‚úÖ Loaded (Age=20, Gender=male)
- Pathology: üîÑ Loading...

**Expected Timeline**: 2-3 hours total (based on previous V4 runs)

### What We're Testing

1. **V2 Athena View Fixes**
   - Procedures query with NULLIF wrappers (lines 424-429)
   - Specimen link query with NULLIF wrappers (line 15)
   - No `INVALID_CAST_ARGUMENT` errors expected

2. **V4.1 Location Tracking**
   - TumorLocationExtractor initialization (FIXED: json_path ‚Üí mapping_path)
   - CBTN code mapping (32 anatomical locations)
   - Laterality detection

3. **V4.1 Institution Tracking**
   - Tier 1: 85% from structured FHIR performer_reference (V2 optimization)
   - Tier 2/3: Fallback to metadata/text extraction (15%)
   - Institution confidence scoring

4. **V2 Cross-Resource Annotation**
   - v2_annotation dict on timeline events
   - specimen_id, encounter_id, performer_org_id linkage
   - Provenance tracking

5. **End-to-End Pipeline**
   - All 6 phases complete without errors
   - JSON artifact generation (Phase 6)
   - Validate V4.1 + V2 data in output

### Monitoring Test Status

```bash
# Use BashOutput tool with bash_id: 0b7fb6
# Or check log file:
tail -f output/v4.1_v2_final_production.log
```

---

## Key File Locations

### Main Script

**File**: [`scripts/patient_timeline_abstraction_V3.py`](scripts/patient_timeline_abstraction_V3.py)
**Size**: 3,947 lines
**Last Modified**: 2025-11-03

**Critical V4.1+V2 Sections**:
- **Lines 1492-1509**: Procedures query with V2 fields (specimen_id, performer_org_id/name, institution_confidence)
- **Lines 1531-1545**: Imaging query with V2 fields (performer_org_id/name, binary_content_id)
- **Lines 1574-1641**: V4.1 institution extraction with V2 Tier 1 optimization
- **Lines 1708-1734**: Surgery events with v2_annotation
- **Lines 1826-1850**: Imaging events with v2_annotation

### V4.1 Libraries

**Tumor Location Extractor**:
- **File**: [`lib/tumor_location_extractor.py`](lib/tumor_location_extractor.py)
- **Fixed**: Line 116 (json_path ‚Üí mapping_path)
- **Features**: 32 CBTN codes, laterality detection, UBERON cross-references

**Institution Tracker**:
- **File**: [`lib/institution_tracker.py`](lib/institution_tracker.py)
- **Features**: 3-tier extraction strategy, confidence scoring

### V2 Athena Views (Fixed)

**v2_procedures_tumor.sql**:
- **File**: [`/Users/resnick/Documents/GitHub/athena_saved_queries/views/v2_procedures_tumor.sql`](../../athena_saved_queries/views/v2_procedures_tumor.sql)
- **Fixed**: Lines 424-429 (added NULLIF to 6 TIMESTAMP casts)
- **Deployed**: 2025-11-03 20:14 (SUCCEEDED)

**v2_procedure_specimen_link.sql**:
- **File**: [`/Users/resnick/Documents/GitHub/athena_saved_queries/views/v2_procedure_specimen_link.sql`](../../athena_saved_queries/views/v2_procedure_specimen_link.sql)
- **Fixed**: Line 15 (added NULLIF to DATE_DIFF calculation)
- **Deployed**: 2025-11-03 20:14 (SUCCEEDED)

**v2_imaging.sql**:
- **File**: [`/Users/resnick/Documents/GitHub/athena_saved_queries/views/v2_imaging.sql`](../../athena_saved_queries/views/v2_imaging.sql)
- **Status**: Working (reference implementation for NULLIF pattern)

### Documentation

**V4.1+V2 Integration Plan**:
- **File**: [`docs/V4.1_V2_SCHEMA_INTEGRATION_PLAN.md`](docs/V4.1_V2_SCHEMA_INTEGRATION_PLAN.md)
- **Size**: 1,100+ lines
- **Content**: Complete V2 integration strategy, 5 implementation steps, performance analysis

**V4.2/V5.0 Upgrade Roadmap**:
- **File**: [`docs/V4.2_V5.0_UPGRADE_ROADMAP.md`](docs/V4.2_V5.0_UPGRADE_ROADMAP.md)
- **Size**: 2,000+ lines
- **Content**: Comprehensive upgrade plan, code examples, testing strategy, RANO implementation

**V4 Base Documentation**:
- **File**: [`docs/V4_IMPLEMENTATION_COMPLETE.md`](docs/V4_IMPLEMENTATION_COMPLETE.md)
- **Content**: V4 base feature documentation (5 features)

**V4 Data Model**:
- **File**: [`docs/TIMELINE_DATA_MODEL_V4.md`](docs/TIMELINE_DATA_MODEL_V4.md)
- **Content**: V4 data model specification

---

## Critical Fixes Applied Today

### Fix #1: V2 Athena View Date Casting (CRITICAL)

**Problem**: `INVALID_CAST_ARGUMENT: Value cannot be cast to date:` errors blocking Phase 1

**Root Cause**: Empty strings in date/timestamp fields cannot be directly cast

**Solution**: Added `NULLIF(field, '')` wrapper to convert empty strings to NULL before casting

**Files Fixed**:
1. **v2_procedures_tumor.sql** (Lines 424-429):
   ```sql
   -- BEFORE (6 fields):
   TRY(CAST(p.performed_date_time AS TIMESTAMP(3))) as proc_performed_date_time,

   -- AFTER (6 fields):
   TRY(CAST(NULLIF(p.performed_date_time, '') AS TIMESTAMP(3))) as proc_performed_date_time,
   ```

2. **v2_procedure_specimen_link.sql** (Line 15):
   ```sql
   -- BEFORE:
   ABS(DATE_DIFF('day', CAST(p.performed_period_start AS DATE), CAST(s.collection_collected_date_time AS DATE))) <= 1

   -- AFTER:
   ABS(DATE_DIFF('day', CAST(NULLIF(p.performed_period_start, '') AS DATE), CAST(NULLIF(s.collection_collected_date_time, '') AS DATE))) <= 1
   ```

**Verification**: Deployed to Athena, test queries succeeded

---

### Fix #2: V4.1 Location Extractor Initialization (CRITICAL)

**Problem**: `BrainTumorLocationNormalizer.__init__() got an unexpected keyword argument 'json_path'`

**Root Cause**: Parameter name mismatch between TumorLocationExtractor and BrainTumorLocationNormalizer

**Solution**: Changed `json_path` to `mapping_path` in tumor_location_extractor.py line 116

**File**: [`lib/tumor_location_extractor.py`](lib/tumor_location_extractor.py) Line 116

```python
# BEFORE:
self.normalizer = BrainTumorLocationNormalizer(
    json_path="/Users/resnick/Documents/GitHub/RADIANT_PCA/BRIM_Analytics/mvp/utils/brain_tumor_location_ontology.json"
)

# AFTER:
self.normalizer = BrainTumorLocationNormalizer(
    mapping_path=Path("/Users/resnick/Documents/GitHub/RADIANT_PCA/BRIM_Analytics/mvp/utils/brain_tumor_location_ontology.json")
)
```

**Verification**: V4.1 features initialized successfully in test 0b7fb6

---

## Environment & Configuration

### Working Directory
```
/Users/resnick/Documents/GitHub/RADIANT_PCA/BRIM_Analytics/patient_clinical_journey_timeline
```

### AWS Configuration
- **Profile**: `radiant-prod`
- **Region**: `us-east-1`
- **S3 Bucket**: `radiant-prd-343218191717-us-east-1-prd-ehr-pipeline`
- **Athena Database**: `fhir_prd_db`
- **Athena Output**: `s3://aws-athena-query-results-545932942738-us-west-2/`

### Key Athena Views

**V2 Views (Fixed)**:
- `fhir_prd_db.v2_procedures_tumor` - Tumor surgeries with V2 enhancements
- `fhir_prd_db.v2_imaging` - Imaging studies with V2 enhancements
- `fhir_prd_db.v2_procedure_specimen_link` - Procedure‚Üîspecimen linkage
- `fhir_prd_db.v2_document_reference_enriched` - Document‚Üîencounter linkage (Step 3-4, not yet used)

**V1 Views (Still in use)**:
- `fhir_prd_db.v_pathology_diagnostics` - Molecular pathology data
- `fhir_prd_db.v_chemotherapy_regimen` - Chemotherapy treatments
- `fhir_prd_db.v_radiation_episodes` - Radiation treatments
- `fhir_prd_db.v_binary_files` - Document inventory (8.1M files)

### MedGemma Configuration
- **Model**: `gemma2:27b` via Ollama
- **Verify**: `ollama list | grep gemma2:27b`
- **Temperature**: 0.1 (for extraction consistency)

### AWS Textract
- **Enabled**: Yes (for TIFF/JPEG/PNG OCR)
- **Cost**: ~$1.50 per 1,000 pages
- **Prioritization**: After HTML/PDF extraction (cost-aware)

---

## Test Patient Details

### Patient Identity
**Patient ID**: `eQSB0y3q.OmvN40Yhg9.eCBk5-9c-Qp-FT3pBWoSGuL83`
**WHO 2021 Diagnosis**: Astrocytoma, IDH-mutant, CNS WHO grade 3
**Age**: 20 years old (as of Phase 1 loading)
**Gender**: Male

### Molecular Profile
- **IDH1**: p.Arg132His mutation (TIER 1A) ‚úÖ
- **ATRX**: Truncating mutation ‚úÖ
- **MSH6**: Germline homozygous (Lynch syndrome / CMMRD) ‚ö†Ô∏è
- **TP53**: Altered ‚ö†Ô∏è
- **DNMT3A**: Altered
- **NF1**: Altered
- **PIK3CA**: Altered
- **MET**: Novel fusion

### Clinical Features
- **Rare Case**: Adult-type diffuse glioma (IDH-mutant) in pediatric dataset
- **Grade**: CNS WHO grade 3 (high-grade)
- **Genetic Syndrome**: Constitutional mismatch repair deficiency (CMMRD)

### Treatment History
- **Surgeries**: 3 procedures
  - Initial resection (2017-09-27)
  - 2 re-resections (dates missing in v_procedures)
- **Radiation**: Multiple courses
  - External institution (Nov 2017) - TIFF document
  - CHOP courses (Apr 2018, Aug 2018)
- **Chemotherapy**: Multiple lines
  - Temozolomide
  - Nivolumab (checkpoint inhibitor)
- **Imaging**: 15 reports
  - 7 with populated `result_information` (4,850 chars)
  - MRI Brain, CT Head

### Testing Challenges (Historical)
- Surgery dates missing (Fix 3 - V2 session)
- External TIFF documents (Fix 6 - V2 session)
- NULL content_type documents (Fix 7 - V2 session)
- Imaging field bug (Fix 4 - V2 session, now using `result_information`)
- Date casting errors (Fix #1 today - V2 views)

---

## Quick Start Commands

### Check Running Test Status
```bash
cd /Users/resnick/Documents/GitHub/RADIANT_PCA/BRIM_Analytics/patient_clinical_journey_timeline

# Use BashOutput tool with bash_id: 0b7fb6
# Or tail log file:
tail -50 output/v4.1_v2_final_production.log
```

### Kill All Old Zombie Processes
```bash
# WARNING: This will kill ALL Python processes for this script
ps aux | grep "patient_timeline_abstraction_V3.py" | grep -v "v4.1_v2_final_production" | awk '{print $2}' | xargs kill -9 2>/dev/null

# Verify only current test running:
ps aux | grep "patient_timeline_abstraction_V3.py" | grep -v grep
```

### Verify AWS SSO Authentication
```bash
export AWS_PROFILE=radiant-prod
aws sts get-caller-identity

# If expired, re-authenticate:
aws sso login --profile radiant-prod
```

### Verify MedGemma Availability
```bash
ollama list | grep gemma2:27b

# If not running, start Ollama:
ollama serve  # In separate terminal
```

### Test Athena View After Fix
```bash
# Test v2_procedures_tumor (should succeed with NULLIF fix)
export AWS_PROFILE=radiant-prod
aws athena start-query-execution \
  --query-string "SELECT patient_fhir_id, procedure_fhir_id, proc_performed_date_time, surgery_type FROM fhir_prd_db.v2_procedures_tumor WHERE patient_fhir_id = 'Patient/eQSB0y3q.OmvN40Yhg9.eCBk5-9c-Qp-FT3pBWoSGuL83' AND is_tumor_surgery = true LIMIT 5" \
  --result-configuration "OutputLocation=s3://aws-athena-query-results-545932942738-us-west-2/" \
  --query-execution-context "Database=fhir_prd_db"
```

### Run New V4.1+V2 Test (After Current Test Completes)
```bash
cd /Users/resnick/Documents/GitHub/RADIANT_PCA/BRIM_Analytics/patient_clinical_journey_timeline

# Verify environment
export AWS_PROFILE=radiant-prod
aws sts get-caller-identity || aws sso login --profile radiant-prod
ollama list | grep gemma2:27b

# Run test
python3 scripts/patient_timeline_abstraction_V3.py \
  --patient-id eQSB0y3q.OmvN40Yhg9.eCBk5-9c-Qp-FT3pBWoSGuL83 \
  --output-dir output/v4.1_v2_validation_$(date +%Y%m%d_%H%M) \
  --force-reclassify
```

---

## Next Session Tasks

### IMMEDIATE: Complete Current Test

1. **Monitor Shell 0b7fb6 Completion**
   - Expected duration: 2-3 hours
   - Watch for Phase 1 data loading success (V2 view fix validation)
   - Monitor Phase 4.5 for V4.1 feature outputs

2. **Validate Test Results**
   - Check `output/v4.1_v2_final_production/timeline_artifact.json`
   - Verify V4.1 features present:
     - `clinical_features.institution` (Tier 1 optimization)
     - `clinical_features.tumor_location` (CBTN codes)
   - Verify V2 annotation present:
     - `v2_annotation.specimen_id`
     - `v2_annotation.encounter_id`
     - `v2_annotation.performer_org_id`

3. **Performance Metrics**
   - Institution tracking: Tier 1 vs Tier 2/3 breakdown
   - Location extraction: Success rate, CBTN coverage
   - V2 optimization: Query performance improvements

### SHORT TERM: Git Commit & Documentation

1. **Commit V4.1+V2 Integration**
   ```bash
   git add -A
   git commit -m "feat: V4.1+V2 integration with location tracking, institution optimization, and V2 schema

   - Integrated V4.1 tumor location extraction (32 CBTN codes)
   - Integrated V4.1 institution tracking (3-tier strategy)
   - Implemented V2 schema Steps 1, 2, 5 (queries, Tier 1 optimization, v2_annotation)
   - Fixed V2 Athena view date casting bugs (v2_procedures_tumor, v2_procedure_specimen_link)
   - Fixed V4.1 location extractor initialization (json_path ‚Üí mapping_path)
   - Created V4.1+V2 integration plan (1,100+ lines)
   - Created V4.2/V5.0 upgrade roadmap (2,000+ lines)

   Key Changes:
   - scripts/patient_timeline_abstraction_V3.py: Lines 1492-1850 (V4.1+V2 integration)
   - lib/tumor_location_extractor.py: Line 116 (initialization fix)
   - athena_saved_queries/views/v2_procedures_tumor.sql: Lines 424-429 (NULLIF fix)
   - athena_saved_queries/views/v2_procedure_specimen_link.sql: Line 15 (NULLIF fix)
   - docs/V4.1_V2_SCHEMA_INTEGRATION_PLAN.md: New (integration strategy)
   - docs/V4.2_V5.0_UPGRADE_ROADMAP.md: New (future enhancements)

   Testing: Full production run (Shell 0b7fb6) in progress"
   ```

2. **Update README.md**
   - Add V4.1+V2 feature summary
   - Update performance metrics
   - Add V4.2/V5.0 roadmap link

3. **Tag Release**
   ```bash
   git tag -a v4.1-v2 -m "V4.1+V2: Location tracking + Institution optimization + V2 schema integration"
   git push origin v4.1-v2
   ```

### MEDIUM TERM: V4.2 Implementation Planning

1. **Review V4.2 Roadmap**
   - Read [`docs/V4.2_V5.0_UPGRADE_ROADMAP.md`](docs/V4.2_V5.0_UPGRADE_ROADMAP.md) in full
   - Prioritize enhancements: Event dataclass (HIGH), V2 Steps 3-4 (HIGH), Measurements (MEDIUM)

2. **ClinicalEvent Dataclass Design**
   - Finalize schema (common fields + type-specific optional fields)
   - Design TumorMeasurement and TreatmentResponse dataclasses
   - Plan migration strategy (parallel dict + dataclass generation ‚Üí full migration)

3. **V2 Steps 3-4 Scoping**
   - Design encounter-based document discovery API
   - Plan fallback logic (encounter link ‚Üí temporal match)
   - Estimate performance improvements (95%+ target)

4. **Tumor Measurement Extraction**
   - Design MedGemma prompts for measurement extraction
   - Plan bidimensional (RANO) + volumetric + qualitative support
   - Create test cases from imaging reports

### LONG TERM: V5.0 RANO Planning

1. **RANO Clinical Validation**
   - Partner with oncologist for gold standard creation
   - Define success metrics (>90% agreement target)
   - Plan 50-patient validation cohort

2. **Longitudinal Tracking Architecture**
   - Design baseline selection logic
   - Plan serial comparison across ‚â•2 timepoints
   - Architect new lesion detection algorithm

3. **Pseudoprogression Research**
   - Literature review on perfusion MRI criteria
   - Explore multi-modal integration (PET, spectroscopy)
   - Define research project scope

---

## Critical Reminders

### NEVER Forget These

1. **Imaging Field Name**: ALWAYS use `result_information` NOT `report_conclusion` in v_imaging queries (Fix 4 - V2 session)

2. **AWS SSO Tokens Expire**: Run `aws sso login --profile radiant-prod` if authentication fails

3. **Many Old Zombie Processes**: 16+ background processes from previous sessions - kill before starting new tests

4. **NULLIF Pattern for Dates**: All Athena view date casts must use `NULLIF(field, '')` to handle empty strings

5. **V4.1 Location Extractor**: Uses `mapping_path` parameter, NOT `json_path`

6. **Textract Costs Money**: ~$1.50 per 1,000 pages - ensure prioritization logic is correct

7. **V2 Steps 3-4 Deferred**: Encounter-based document discovery planned for V4.2, not yet implemented

8. **Backward Compatibility**: All V4.1+V2 changes are additive - V3/V4 consumers unaffected

### Background Processes to Clean Up

As of 2025-11-03 20:45, the following zombie processes exist:
- d75197, 6353e3, 57bfa4, 2d1f25, 1a7b5e, 876c22, b4821b, e0dca7, 796d36, 55c8c2, 8dfd92, 9ff4f2, 58e81c, 69da66, 3c4ca1, e1a75e, 211b68

**Action**: Kill all EXCEPT 0b7fb6 (current production test)

---

## Version History

### V4.1+V2 (Current - 2025-11-03)
- Tumor location extraction (32 CBTN codes)
- Institution tracking (3-tier strategy with V2 Tier 1 optimization)
- V2 schema integration (Steps 1, 2, 5)
- Fixed V2 Athena view date casting bugs
- Fixed V4.1 location extractor initialization
- Created V4.2/V5.0 upgrade roadmap

### V4 (2025-11-03)
- WHO Reference Triage (86.8% context reduction)
- Treatment Ordinality (surgery #, treatment line #, radiation course #)
- TIFF Date Mismatch detection (external institution data capture)
- EOR Orchestrator (multi-source adjudication)
- FeatureObject Pattern (complete provenance tracking)

### V3 (2025-11-02)
- Dynamic WHO 2021 classification (Tier 1 + Tier 2)
- 7-stage timeline construction
- Gap identification and prioritization
- Binary extraction (HTML/PDF/TIFF/JPEG/PNG + NULL fallback)
- Phase 4.5 orchestrator assessment

### V2 (2025-11-02)
- 8 critical bug fixes (gap merge, imaging field, TIFF support, etc.)
- AWS Textract integration
- JPEG/PNG support
- NULL content_type fallback

---

## References

### Documentation
- **V4.1+V2 Plan**: [`docs/V4.1_V2_SCHEMA_INTEGRATION_PLAN.md`](docs/V4.1_V2_SCHEMA_INTEGRATION_PLAN.md)
- **V4.2/V5.0 Roadmap**: [`docs/V4.2_V5.0_UPGRADE_ROADMAP.md`](docs/V4.2_V5.0_UPGRADE_ROADMAP.md)
- **V4 Docs**: [`docs/V4_IMPLEMENTATION_COMPLETE.md`](docs/V4_IMPLEMENTATION_COMPLETE.md)
- **V4 Data Model**: [`docs/TIMELINE_DATA_MODEL_V4.md`](docs/TIMELINE_DATA_MODEL_V4.md)
- **V3 Docs**: [`docs/V3_IMPLEMENTATION_COMPLETE.md`](docs/V3_IMPLEMENTATION_COMPLETE.md)

### WHO 2021 Reference
- **File**: `/Users/resnick/Documents/GitHub/RADIANT_PCA/BRIM_Analytics/mvp/References/WHO_2021s.pdf`
- **Usage**: Referenced in WHO classification prompts

### Code References
- **Main Script**: [`scripts/patient_timeline_abstraction_V3.py`](scripts/patient_timeline_abstraction_V3.py) (3,947 lines)
- **Location Extractor**: [`lib/tumor_location_extractor.py`](lib/tumor_location_extractor.py)
- **Institution Tracker**: [`lib/institution_tracker.py`](lib/institution_tracker.py)
- **Feature Object**: [`lib/feature_object.py`](lib/feature_object.py)
- **EOR Orchestrator**: [`lib/eor_orchestrator.py`](lib/eor_orchestrator.py)

---

## Example V4.1+V2 Output

### Surgery Event with V4.1 + V2 Features

```json
{
  "event_type": "surgery",
  "event_date": "2017-09-27",
  "stage": 2,
  "source": "v_procedures_tumor",
  "description": "Craniotomy for resection of brain tumor",
  "surgery_type": "craniotomy_tumor_resection",
  "proc_performed_datetime": "2017-09-27T10:30:00",

  "surgery_number": 1,
  "surgery_label": "Initial resection (surgery #1)",

  "extent_of_resection_v4": {
    "value": "STR",
    "sources": [
      {
        "source_type": "operative_note",
        "extracted_value": "STR",
        "extraction_method": "medgemma_llm",
        "confidence": "MEDIUM",
        "source_id": "Binary/abc123",
        "extracted_at": "2025-11-03T20:45:00Z"
      }
    ]
  },

  "clinical_features": {
    "institution": {
      "value": "Children's Hospital of Philadelphia",
      "sources": [
        {
          "source_type": "structured_fhir",
          "extracted_value": "Children's Hospital of Philadelphia",
          "extraction_method": "fhir_performer_reference",
          "confidence": "HIGH",
          "source_id": "Organization/chop",
          "extracted_at": "2025-11-03T20:45:00Z"
        }
      ]
    },
    "tumor_location": {
      "value": "Right frontal lobe",
      "cbtn_code": 8,
      "uberon_id": "UBERON:0002733",
      "laterality": "right",
      "sources": [
        {
          "source_type": "operative_note",
          "extracted_value": "right frontal mass",
          "extraction_method": "llm_extraction",
          "confidence": "HIGH",
          "extracted_at": "2025-11-03T20:45:15Z"
        }
      ]
    }
  },

  "v2_annotation": {
    "specimen_id": "Specimen/xyz789",
    "encounter_id": "Encounter/enc123",
    "performer_org_id": "Organization/chop",
    "procedure_id": "Procedure/proc456"
  }
}
```

---

**Last Updated**: 2025-11-03 20:45 EST
**Author**: Claude (Anthropic) - Session 2025-11-03
**Project**: RADIANT_PCA BRIM Analytics
**Status**: üîÑ V4.1+V2 PRODUCTION VALIDATION IN PROGRESS ‚Üí V4.2/V5.0 PLANNING READY
